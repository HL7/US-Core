<!-- ================================================================
 The following Profile list is generated by the liquid script below.
 The source data is at temp/pages/_data/structuredefinitions.json
 which is automatically generated by the build
 and the input/data/profile-metadata.csv where manual edits to the table contents are made
 when new profile are added, deprecated, etc.

profile-metadata.csv columns:

- row: row id
- id: profile or extension's StructureDefinition id
- uri: profile or extension's canonical url
- title: profile or extension's human readable name
- rel_url: profile or extension's relative path to the narrative content page in the IG.
- is_new: Flag for new or updated content for the current version. Default is "FALSE" and set to "TRUE for new or updated content for the current version. It is used for QA review and published ballot versions of the guide. It set to "FALSE" before publishing new versions of the guide.
- current_fmm: FMM level in the current published version
- proposed_fmm: Proposed FMM level for next version
- added: Published version when the profile or extension was added to the guide.
- deprecated: Published version when the profile or extension was deprerated.
- retired: Published version when the profile or extension was retired.
- ig_only: Used for extensions only. Flag to indicate if the extension is used only for US Core StructureDefinitions. It is not a USCDI nor Realm specific requirement.
- realm_only:  Used for extensions only. Flag to indicate if the extension is defined for use in US Realm but is not a USCDI related requirement.
- version_notes: Notes on changes between versions. Used to inform readers in plain human readable text.
- dstu2_profile_title: Mapping of the profile or extensions to the Argonaut query DSTU2 profiles or extensions.
- ipa_compatibility: Compliance with the International Patient Access (IPA) values: "OK" = Compliant, "MAYBE" = Additional requirements needed to meet all requirements , "NO" = Incompatble ,"NA" = No equivalent profile:
- ips_compatibility: Compliance with the International Patient Summary (IPS) values: "OK" = Compliant, "MAYBE" = Additional requirements needed to meet all requirements , "NO" = Incompatble ,"NA" = No equivalent profile:
- resource_scope_conf: Resource Level SMART Scope requirements, Values: "SHALL"|"SHOULD"|"MAY"
- data_element: USCDI/HTI-1 defined scope contexts
- resource_type: profile or extension's base resource type. It is "Extension" for extensions.
- cat[n]_scope: (n =  1..6). Multiple granular scopes may be defined for a profile.
- cat[n]_scope_conf: (n =  1..6) Resource Level SMART Scope requirements, Values: "SHALL"|"SHOULD"|"MAY"  Multiple granular scopes may be defined for a profile.

It create a list, grouped by type, sorted alphabetically by title, adds relative links, and allows for highlighting new and updated content.
 ====================================================================== -->


{%- for sd_hash in site.data.structuredefinitions -%}
  {%- assign sd1= sd_hash[1] -%}
  {%- unless sd1.type == "Extension" -%}
    {% assign types =  types | append: "," | append: sd1.type %}
  {%- endunless -%}
{% endfor %}
{% assign my_types = types | split: "," %}
{% assign my_types = my_types | sort | uniq %}
{% for i in my_types offset:1 %}
  <h4>{{ i }}</h4>
  <ul>
    {%- for sd_hash in site.data.structuredefinitions -%}
      {%- assign sd1 = sd_hash[1] -%}
      {%- if sd1.type == i %}
        {%- assign new = false -%}
        {%- assign parent = false -%}
        {%- assign child = false -%}
        {%- for sd_hash2 in site.data.structuredefinitions -%}
          {%- assign sd2 = sd_hash2[1] -%}
          {% if sd1.basename == sd2.name %}
            {%- assign child = true -%}
            {% break %}
          {% elsif sd1.name == sd2.basename%}
             {%- assign parent = true -%}
             {% break %}
          {% endif %}
        {% endfor %}

        {%- assign profile_meta_row = site.data.profile_metadata | where:"title", sd1.title | first -%}
          {%- if profile_meta_row.is_new  == "TRUE" -%}
                {%- assign new = true -%}
          {%- endif -%}

          {%- unless parent or child -%}
            {%- if new -%}
              <li><a href="{{sd1.path}}"><span class="bg-success" markdown="1">{{sd1.title}}</span><!-- new-content --></a></li>
            {% else %}
              <li><a href="{{sd1.path}}">{{sd1.title}}</a></li>
            {% endif %}
          {%- endunless -%}

          {%- if parent -%}
            {%- if new -%}
              <li><a href="{{sd1.path}}"><span class="bg-success" markdown="1">{{sd1.title}}</span><!-- new-content --></a>
            {% else %}
              <li><a href="{{sd1.path}}">{{sd1.title}}</a>
            {% endif %}
                <ul>
                {%- for sd_hash3 in site.data.structuredefinitions -%}
                  {%- assign sd3 = sd_hash3[1] -%}
                  {% if sd1.name == sd3.basename %}
                    {%- assign new = false -%}
                    {%- assign profile_meta_row = site.data.profile_metadata | where:"title", sd3.title | first -%}
                     {%- if profile_meta_row.is_new  == "TRUE" -%}
                           {%- assign new = true -%}
                      {%- endif -%}
                      {%- if new -%}
                        <li><a href="{{sd3.path}}"><span class="bg-success" markdown="1">{{sd3.title}}</span><!-- new-content --></a></li>
                      {% else %}
                        <li><a href="{{sd3.path}}">{{sd3.title}}</a></li>
                      {% endif %}

                  {% endif %}
                {% endfor %}
                </ul>
            </li>
          {%- endif -%}
      {%- endif -%}
    {%- endfor -%}
  </ul>
{% endfor %}
